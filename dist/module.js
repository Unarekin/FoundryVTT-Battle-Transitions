"use strict";(()=>{var Me="transition-cover",He="BATTLETRANSITIONS",We="\u2694\uFE0F",ze={INITIALIZE:"battle-transitions.init",TRANSITION_START:"battle-transitions.transitionStart",TRANSITION_END:"battle-transitions.transitionEnd"};var q=class extends PIXI.Container{setInverseMatrix(){canvas?.app?.stage&&this.transform.setFromMatrix(canvas.app.stage.localTransform.clone().invert())}constructor(){super(),this.interactiveChildren=!1,this.interactive=!1,this.eventMode="none",canvas?.app&&canvas.app.renderer.addListener("prerender",()=>{this.setInverseMatrix()})}};var c=class extends Error{constructor(e,t){e?super(game.i18n?.format(`${He}.ERRORS.${e}`,t)):super()}};var y=class extends c{constructor(){super("CANNOTINITIALIZECANVAS")}};var ee=class extends c{constructor(){super("CANVASNOTFOUND")}};var se=class extends c{constructor(e){super("FILENOTFOUND",{file:e})}};var S=class extends c{constructor(e){super("INVALIDDIRECTION",{direction:e})}};var ae=class extends c{constructor(){super("INVALIDELEMENT")}};var te=class extends c{constructor(e){super("INVALIDMACRO",{macro:e})}};var x=class extends c{constructor(e){super("INVALIDSCENE",{name:e})}};var A=class extends c{constructor(){super("INVALIDTEXTURE")}};var h=class extends c{constructor(e){super("INVALIDTRANSITION",{name:e})}};var ue=class extends c{constructor(){super("NOCOVERELEMENT")}};var ce=class extends c{constructor(){super("NOTINITIALIZED")}};var le=class extends c{constructor(){super("EXECUTECALLEDPARALLEL")}};var pe=class extends c{constructor(){super("PERMISSIONDENIED")}};var me=class extends c{constructor(){super("TRANSITIONTOSELF")}};function St(i){try{return new PIXI.Color(i)}catch{}}function p(i){let e=St(i);if(e)return l(e);try{return PIXI.Texture.from(i)}catch{}}function re(i){if(game instanceof Game&&game.scenes){if(typeof i=="string"){let e=game.scenes.get(i);if(e||(e=game.scenes.getName(i),e))return e}else if(i instanceof Scene)return i}}function Fe(i){if(i instanceof Macro)return i;if(game.macros&&typeof i=="string"){let e=game.macros?.get(i);if(e||(e=game.macros?.getName(i),e))return e;if(i.split(".")[0]==="Macro")return game.macros?.get(i.split(".").slice(1).join("."))}}var je=Math.sqrt(3),Ve=Math.sqrt(5),ht=.5*(je-1),ie=(3-je)/6,Gr=1/3,$r=1/6,jr=(Ve-1)/4,Vr=(5-Ve)/20,Ge=i=>Math.floor(i)|0,$e=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function Ke(i=Math.random){let e=bt(i),t=new Float64Array(e).map(o=>$e[o%12*2]),r=new Float64Array(e).map(o=>$e[o%12*2+1]);return function(n,s){let u=0,f=0,b=0,N=(n+s)*ht,g=Ge(n+N),V=Ge(s+N),Ue=(g+V)*ie,gt=g-Ue,It=V-Ue,D=n-gt,R=s-It,oe,ne;D>R?(oe=1,ne=0):(oe=0,ne=1);let Le=D-oe+ie,_e=R-ne+ie,De=D-1+2*ie,Re=R-1+2*ie,Pe=g&255,ke=V&255,K=.5-D*D-R*R;if(K>=0){let v=Pe+e[ke],Y=t[v],Z=r[v];K*=K,u=K*K*(Y*D+Z*R)}let Q=.5-Le*Le-_e*_e;if(Q>=0){let v=Pe+oe+e[ke+ne],Y=t[v],Z=r[v];Q*=Q,f=Q*Q*(Y*Le+Z*_e)}let J=.5-De*De-Re*Re;if(J>=0){let v=Pe+1+e[ke+1],Y=t[v],Z=r[v];J*=J,b=J*J*(Y*De+Z*Re)}return 70*(u+f+b)}}function bt(i){let t=new Uint8Array(512);for(let r=0;r<512/2;r++)t[r]=r;for(let r=0;r<512/2-1;r++){let o=r+~~(i()*(256-r)),n=t[r];t[r]=t[o],t[o]=n}for(let r=256;r<512;r++)t[r]=t[r-256];return t}var Qe=`precision highp float;

uniform sampler2D uSampler;
in vec2 vTextureCoord;
out vec4 color;

void main() {
    color = texture(uSampler, vTextureCoord);
}`;var Je=`in vec2 aVertexPosition;

uniform mat3 projectionMatrix;

out vec2 vTextureCoord;

uniform vec4 inputSize;
uniform vec4 outputFrame;

vec4 filterVertexPosition(void) {
    vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;
    
    return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);
}

vec2 filterTextureCoord(void) {
    return aVertexPosition * (outputFrame.zw * inputSize.zw);
}

void main(void) {
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`;var d=class extends PIXI.Filter{constructor(e,t,r){super(e||Je,t||Qe,r),this.program.fragmentSrc.includes("#version 300 es")||(this.program.fragmentSrc=`#version 300 es 
`+this.program.fragmentSrc),this.program.vertexSrc.includes("#version 300 es")||(this.program.vertexSrc=`#version 300 es
`+this.program.vertexSrc)}};var Ye=`precision highp float;

in vec2 vTextureCoord;
out vec4 color;

uniform sampler2D uSampler;
uniform sampler2D noise_texture;
uniform sampler2D burn_texture;

uniform float integrity;
uniform float burn_size;

float inverse_lerp(float a, float b, float v) {
    return (v - a) / (b - a);
}

void main() {
    float noise = texture(noise_texture, vTextureCoord).r * vTextureCoord.y;
    vec4 base_color = texture(uSampler, vTextureCoord) * step(noise, integrity);
    vec2 burn_uv = vec2(inverse_lerp(integrity, integrity * burn_size, noise), 0.0);
    vec4 burn_color = texture(burn_texture, burn_uv) * step(noise, integrity * burn_size);
    
    color = mix(burn_color, base_color, base_color.a);
    // color = texture(uSampler, vTextureCoord);
}`;var Nt=qe(1024,new PIXI.Color("#ff0400"),new PIXI.Color("#ffff01")),P=class extends d{constructor(e="transparent",t=1.3){let o={noise_texture:Ze(),integrity:1,burn_size:t,burn_texture:Nt};super(void 0,Ye,o)}};var et=`precision highp float;

uniform sampler2D uSampler;
in vec2 vTextureCoord;
out vec4 color;

uniform float progress;
uniform float size;
uniform vec2 screen_size;
uniform sampler2D bgSampler;

void main() {
    vec2 screenCoord = screen_size * vTextureCoord;
    
    float x = abs(fract(screenCoord.x / size) - 0.5);
    float y = abs(fract(screenCoord.y / size) - 0.5);
    
    if (x + y + vTextureCoord.x > progress * 2.0) {
        color = texture(uSampler, vTextureCoord);
    } else {
        color = texture(bgSampler, vTextureCoord);
    }
}`;var k=class extends d{constructor(e,t="transparent"){let r=p(t)??l("transparent");super(void 0,et,{progress:0,size:e,bgSampler:r,screen_size:{x:window.innerWidth,y:window.innerHeight}})}};var tt=`precision highp float;

uniform sampler2D uSampler;
in vec2 vTextureCoord;
out vec4 color;

uniform float progress;
uniform sampler2D wipeSampler;
uniform sampler2D bgSampler;

void main() {
    vec4 wipe = texture(wipeSampler, vTextureCoord);
    
    if (wipe.b < progress) {
        color = texture(bgSampler, vTextureCoord);
    } else {
        color = texture(uSampler, vTextureCoord);
    }
}`;var At=l(new PIXI.Color("#00000000")),I=class extends d{constructor(e,t){let r={progress:0,wipeSampler:e,bgSampler:t??At};super(void 0,tt,r)}};var rt=`precision highp float;

uniform sampler2D uSampler;
in vec2 vTextureCoord;
out vec4 color;

uniform float progress;
uniform sampler2D bgColor;

void main() {
    color = mix(texture(uSampler, vTextureCoord), texture(bgColor, vTextureCoord), progress);
}`;var M=class extends d{constructor(e="transparent"){let t=p(e)??l("transparent");super(void 0,rt,{bgColor:t,progress:0})}};var Ot={horizontal:{inside:"bilinear-horizontal-inside.webp",outside:"bilinear-horizontal-outside.webp"},vertical:{inside:"bilinear-vertical-inside.webp",outside:"bilinear-vertical-outside.webp"},topleft:{inside:"bilinear-top-left-inside.webp",outside:"bilinear-top-right-outside.webp"},topright:{inside:"bilinear-top-right-inside.webp",outside:"bilinear-top-right-outside.webp"},bottomleft:{inside:"bilinear-top-right-inside.webp",outside:"bilinear-top-right-outside.webp"},bottomright:{inside:"bilinear-top-left-inside.webp",outside:"bilinear-top-right-outside.webp"}},F=class extends I{constructor(e,t,r){let o=p(r)??l("transparent"),n=Ot[e]?.[t];if(!n)throw new S(`${e}-${t}`);let s=PIXI.Texture.from(`/modules/battle-transitions/assets/wipes/${n}`);super(s,o)}};var Lt={left:"linear-left.webp",right:"linear-right.webp",top:"linear-top.webp",bottom:"linear-bottom.webp",topleft:"linear-top-left.webp",topright:"linear-top-right.webp",bottomleft:"linear-bottom-left.webp",bottomright:"linear-bottom-right.webp"},B=class extends I{constructor(e,t){let r=p(t)??l("transparent"),o=Lt[e];if(!o)throw new S(e);let n=PIXI.Texture.from(`/modules/battle-transitions/assets/wipes/${o}`);super(n,r)}};var _t={clockwise:{top:"clockwise-top.webp",left:"clockwise-left.webp",right:"clockwise-right.webp",bottom:"clockwise-bottom.webp"},counterclockwise:{top:"anticlockwise-top.webp",left:"anticlockwise-left.webp",right:"anticlockwise-right.webp",bottom:"anticlockwise-bottom.webp"}},X=class extends I{constructor(e,t,r){let o=p(r)??l("transparent"),n=_t[e]?.[t];if(!n)throw new S(`${e}-${t}`);let s=PIXI.Texture.from(`/modules/battle-transitions/assets/wipes/${n}`);super(s,o)}};var Dt={left:{inside:"spotlight-left-inside.webp",outside:"spotlight-right-outside.webp"},top:{inside:"spotlight-top-inside.webp",outside:"spotlight-top-outside.webp"},right:{inside:"spotlight-right-inside.webp",outside:"spotlight-right-outside.webp"},bottom:{inside:"spotlight-bottom-inside.webp",outside:"spotlgiht-bottom-outside.webp"}},U=class extends I{constructor(e,t,r="transparent"){let o=p(r)??l("transparent"),n=Dt[e]?.[t];if(!n)throw new S(`${e}-${t}`);let s=PIXI.Texture.from(`/modules/battle-transitions/assets/wipes/${n}`);super(s,o)}};var Rt={inside:"radial-inside.webp",outside:"radial-outside.webp"},H=class extends I{constructor(e,t){let r=p(t)??l("transparent"),o=Rt[e];if(!o)throw new S(e);let n=PIXI.Texture.from(`/modules/battle-transitions/assets/wipes/${o}`);super(n,r)}};var it=`precision highp float;

uniform sampler2D uSampler;
in vec2 vTextureCoord;
out vec4 color;

uniform sampler2D uTexture;

void main() {
    color = texture(uTexture, vTextureCoord);
}`;var O=class extends d{constructor(e){let t=p(e);if(!t)throw new A;super(void 0,it,{uTexture:t})}};var ot=`precision highp float;

uniform sampler2D uSampler;
in vec2 vTextureCoord;
out vec4 color;

uniform float progress;
uniform float[512] offsets;
uniform sampler2D uBackground;

void main() {
    vec2 tex_uv = vTextureCoord;

    float index = tex_uv.x * float(offsets.length());
    tex_uv.y -= progress * offsets[int(index)];

    // float index = tex_uv.x * float(offsets.length());
    // tex_uv.y -= progress * offsets[int(index)];

    color = texture(uSampler, tex_uv);
    if (tex_uv.y < 0.0 || tex_uv.y > 1.0) color = vec4(0.0); // texture(uBackground, vTextureCoord);
}

// precision highp float;

// uniform sampler2D uSampler;
// in vec2 vTextureCoord;
// out vec4 color;

// uniform float progress;
// uniform float meltiness;
// uniform vec2 texture_size;

// float pseudo_rand(float x) {
//     return mod(x * 2048103.0 + cos(x * 1912.0), 1.0);
// }

// void main() {
//     vec2 uv = vec2(vTextureCoord.x, vTextureCoord.y);

//     uv.y -= progress / vTextureCoord.y;
//     uv.y -= progress * meltiness * pseudo_rand(vTextureCoord.x - mod(vTextureCoord.x, texture_size.x));

//     color = texture(uSampler, uv);
//     if (uv.y <= 0.0) {

//     }
// }`;var W=class extends d{constructor(e){let t=p(e);if(!(t instanceof PIXI.Texture))throw new A;super(void 0,ot,{progress:0,offsets:new Array(512).fill(0).map(()=>Math.random()+1),uBackground:t})}};var nt=`precision highp float;

uniform sampler2D uSampler;
in vec2 vTextureCoord;
out vec4 color;

uniform float progress;
uniform float shake_power;
uniform float shake_block_size;
uniform vec2 direction_r;
uniform vec2 direction_g;
uniform vec2 direction_b;
uniform sampler2D background;

float random(float seed) {
    return fract(543.2543 * sin(dot(vec2(seed, seed), vec2(3525.46, -54.3415))));
}

void main() {
    vec2 fixed_uv = vTextureCoord;
    fixed_uv.x += (
        random(
            (trunc(vTextureCoord.y * shake_block_size) / shake_block_size)
            +	progress) - 0.5) * shake_power * (progress * 12.0);

    color = 
    vec4(
        textureLod(uSampler, fixed_uv + normalize(direction_r) * progress, 0.0).r
        ,	textureLod(uSampler, fixed_uv + normalize(direction_g) * progress, 0.0).g
        ,	textureLod(uSampler, fixed_uv + normalize(direction_b) * progress, 0.0).b
        ,	0.0) * (1.0 - progress);
    // * texture(background, vTextureCoord);
    color.a = 1.0;
}
`;var z=class extends d{constructor(e="transparent"){let t=p(e)??l("transparent");super(void 0,nt,{progress:0,shake_power:.03,shake_block_size:30.5,direction_r:[1,0],direction_g:[.4,1],direction_b:[-.7,-.3],background:t})}};var G=class i{#e="none";#r=null;#t=[];#s=[];#i=null;#o={bilinearwipe:this.#a.bind(this),clockwipe:this.#l.bind(this),diamondwipe:this.#p.bind(this),fade:this.#m.bind(this),firedissolve:this.#c.bind(this),glitch:this.#u.bind(this),linearwipe:this.#d.bind(this),macro:this.#f.bind(this),melt:this.#T.bind(this),parallel:this.#g.bind(this),radialwipe:this.#I.bind(this),removeoverlay:this.#S.bind(this),spotlightwipe:this.#b.bind(this),textureswap:this.#x.bind(this),sound:this.#h.bind(this),video:this.#E.bind(this),wait:this.#C.bind(this)};constructor(e){try{if(e){let t=re(e);if(!t)throw new x(e);this.#r=t}}catch(t){throw ui.notifications?.error(t.message),t}}get sequence(){return this.#t}static Cleanup(){Be()}static async SelectScene(){let e=await renderTemplate("/modules/battle-transitions/templates/scene-selector.hbs",{scenes:game.scenes?.contents.map(t=>({id:t.id,name:t.name}))});return Dialog.wait({title:a("BATTLETRANSITIONS.SCENESELECTOR.TITLE"),content:e,default:"ok",buttons:{cancel:{icon:"<i class='fas fa-times'></i>",label:a("BATTLETRANSITIONS.DIALOGS.BUTTONS.CANCEL"),callback:()=>null},ok:{icon:"<i class='fas fa-check'></i>",label:a("BATTLETRANSITIONS.DIALOGS.BUTTONS.OK"),callback:t=>game.scenes?.get($(t).find("#scene").val())??null}}})}static TriggerForScene(e){let t=re(e);if(!t)throw new x(typeof e=="string"?e:typeof e);let r=t.getFlag("battle-transitions","steps")??[];r.length&&L.transition(t.id??"",r)}bilinearWipe(e,t,r=1e3,o="transparent",n=this.#e){new F(e,t,o);let s=E(o);return this.#t.push({type:"bilinearwipe",duration:r,direction:e,radial:t,background:s,easing:n}),this}burn(e=1e3,t="transparent",r=1.3,o=this.#e){return new P(t,r),this.#t.push({type:"firedissolve",background:E(t),duration:e,burnSize:r,easing:o}),this}clockWipe(e,t,r=1e3,o="transparent",n=this.#e){return new X(e,t,o),this.#t.push({type:"clockwipe",duration:r,background:E(o),direction:t,clockdirection:e,easing:n}),this}diamondWipe(e,t=1e3,r="transparent",o=this.#e){return new k(e,r),this.#t.push({type:"diamondwipe",size:e,background:E(r),duration:t,easing:o}),this}async execute(e=!1,t,r){try{if(!this.#r)throw new x("undefined");if(this.#r.id===canvas?.scene?.id)throw new me;if(e){if(!t)throw new h(typeof t);let o=await st();this.#i=o.children[1],at(),r!==game.users?.current?.id?await de("canvasReady"):r===game.users?.current?.id&&await lt(this.#r),ut(),ct(),await this.#n(t,o),Be(o)}else{if(!this.#r.canUserModify(game.users?.current??null,"update"))throw new pe;L.transition(this.#r.id??"",t||this.#t)}}catch(o){ui.notifications?.error(o.message)}}fade(e,t="transparent",r=this.#e){return new M(t),this.#t.push({type:"fade",duration:e,background:E(t),easing:r}),this}linearWipe(e,t=1e3,r="transparent",o=this.#e){new B(e,r);let n=E(r);return this.#t.push({type:"linearwipe",duration:t,direction:e,background:n,easing:o}),this}macro(e){let t=Fe(e);if(!t)throw new te(typeof e=="string"?e:typeof e);return this.#t.push({type:"macro",macro:t.id}),this}melt(e=1e3,t="transparent",r=this.#e){return new W(t),this.#t.push({type:"melt",duration:e,background:E(t),easing:r}),this}parallel(...e){let t=[];for(let r of e){let o=new i;if(r(o)instanceof Promise)throw new le;t.push(o.sequence)}return this.#t.push({type:"parallel",sequences:t}),this}radialWipe(e,t=1e3,r="transparent",o=this.#e){return new H(e,r),this.#t.push({type:"radialwipe",duration:t,radial:e,background:E(r),easing:o}),this}removeOverlay(){return this.#t.push({type:"removeoverlay"}),this}sound(e,t=100){return this.#t.push({type:"sound",file:typeof e=="string"?e:e.src,volume:t}),this}spotlightWipe(e,t,r=1e3,o="transparent",n=this.#e){return new U(e,t,o),this.#t.push({type:"spotlightwipe",direction:e,radial:t,duration:r,background:E(o),easing:n}),this}textureSwap(e){return new O(e),this.#t.push({type:"textureswap",texture:E(e)}),this}video(e,...t){let r=t.find(s=>typeof s=="number")??100,o=t.find(s=>typeof s=="boolean")??!1,n=t.find(s=>!(typeof s=="boolean"||typeof s=="number"))??"transparent";return _("Arguments:",t),_("Parsed:",e,r,n,o),this.#t.push({type:"video",file:e,volume:r,background:n,clear:o}),this}wait(e){return this.#t.push({type:"wait",duration:e}),this}async#a(e,t){let r=C(e.background),o=new F(e.direction,e.radial,r.baseTexture);Array.isArray(t.filters)?t.filters.push(o):t.filters=[o],await TweenMax.to(o.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}glitch(e=1e3,t="transparent"){return new z(t),this.#t.push({type:"glitch",duration:e}),this}async#u(e,t){let r=new z;Array.isArray(t.filters)?t.filters.push(r):t.filters=[r],await TweenMax.to(r.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#c(e,t){let r=new P(e.background,e.burnSize);Array.isArray(t.filters)?t.filters.push(r):t.filters=[r],await TweenMax.to(r.uniforms,{integrity:0,duration:e.duration/1e3,ease:e.easing||this.#e})}async#l(e,t){let r=C(e.background),o=new X(e.clockdirection,e.direction,r.baseTexture);Array.isArray(t.filters)?t.filters.push(o):t.filters=[o],await TweenMax.to(o.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#p(e,t){let r=C(e.background),o=new k(e.size,r.baseTexture);Array.isArray(t.filters)?t.filters.push(o):t.filters=[o],await TweenMax.to(o.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#m(e,t){let r=C(e.background),o=new M(r.baseTexture);Array.isArray(t.filters)?t.filters.push(o):t.filters=[o],await TweenMax.to(o.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#d(e,t){let r=C(e.background??l("transparent")),o=new B(e.direction,r.baseTexture);Array.isArray(t.filters)?t.filters.push(o):t.filters=[o],await TweenMax.to(o.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#f(e){let t=Fe(e.macro);if(!t)throw new te(e.macro);let r=t.execute();if(r instanceof Promise)await r;else return Promise.resolve()}async#T(e,t){let r=C(e.background),o=new W(r.baseTexture);Array.isArray(t.filters)?t.filters.push(o):t.filters=[o],await TweenMax.to(o.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing??"none"})}async#g(e,t){await Promise.all(e.sequences.map(r=>this.#n(r,t)))}async#I(e,t){let r=C(e.background),o=new H(e.radial,r.baseTexture);Array.isArray(t.filters)?t.filters.push(o):t.filters=[o],await TweenMax.to(o.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#S(){return this.#i&&(this.#i.alpha=0),Promise.resolve()}async#n(e,t){for(let r of e){if(typeof this.#o[r.type]!="function")throw new h(r.type);let o=this.#o[r.type];typeof o=="function"&&await o(r,t)}}async#h(e){await foundry.audio.AudioHelper.preloadSound(e.file);let t=await foundry.audio.AudioHelper.play({src:e.file,volume:e.volume/100,autoplay:!0},!0);return this.#s.push(t),Promise.resolve()}async#b(e,t){let r=C(e.background),o=new U(e.direction,e.radial,r.baseTexture);Array.isArray(t.filters)?t.filters.push(o):t.filters=[o],await TweenMax.to(o.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#x(e,t){let r=C(e.texture),o=new O(r.baseTexture);return Array.isArray(t.filters)?t.filters.push(o):t.filters=[o],Promise.resolve()}async#E(e,t){if(!await srcExists(e.file))throw new se(e.file);let o=await PIXI.Assets.load(e.file),s=o.baseTexture.resource.source,u=C(e.background);return new Promise((f,b)=>{s.addEventListener("ended",()=>{e.clear&&(Array.isArray(t.filters)&&t.filters.includes(g)&&t.filters.splice(t.filters.indexOf(g),1),g.destroy()),f()}),s.addEventListener("error",V=>{b(V.error)});let N=new O(u.baseTexture),g=new O(o.baseTexture);Array.isArray(t.filters)?t.filters.push(N,g):t.filters=[N,g],s.volume=e.volume/100,s.play()})}async#C(e){return new Promise(t=>{setTimeout(t,e.duration)})}};var Xe=class{#e;transition(e,t){this.#e.executeForEveryone("transition.exec",e,t,game.users?.current?.id??"")}_execute(e,t,r){_("Executing transition chain:",t),new G(e).execute(!0,t,r)}register(e){_("Registering socket:",e),this.#e=e,e.register("transition.exec",this._execute.bind(this))}},L=new Xe;function Ze(i=256,e=256,t){let r=Ke(t),o=document.createElement("canvas"),n=o.getContext("2d");if(!n)throw new y;o.width=i,o.height=e;let s=n.createImageData(o.width,o.height),u=s.data;for(let f=0;f<o.height;f++)for(let b=0;b<o.width;b++){let N=r(b/32,f/32),g=(f*o.width+b)*4;u[g]=N*255,u[g+1]=N*255,u[g+2]=N*255,u[g+3]=255}return n.putImageData(s,0,0),PIXI.Texture.from(o)}function qe(i,e,t){let r=document.createElement("canvas");r.width=i,r.height=1;let o=r.getContext("2d");if(!o)throw new y;let n=o.createLinearGradient(0,0,i,0),s=e??new PIXI.Color("white"),u=t??new PIXI.Color("black");return n.addColorStop(0,s.toHex()),n.addColorStop(1,u.toHex()),o.fillStyle=n,o.fillRect(0,0,i,1),PIXI.Texture.from(r)}function l(i){let e=document.createElement("canvas");e.width=1,e.height=1;let t=e.getContext("2d");if(!t)throw new y;let r=new PIXI.Color(i);return t.fillStyle=r.toHexa(),t.fillRect(0,0,1,1),PIXI.Texture.from(e)}async function de(i){return new Promise(e=>{Hooks.once(i,(...t)=>{e(t)})})}function a(i,e={}){return game.i18n?.format(i,e)??i}function fe(){return game.release?.isNewer("12")??!1}function pt(i){let e=atob(i.split(",")[1]),t=new Uint8Array(e.length);for(let r=0;r<t.length;r++)t[r]=e.charCodeAt(r);return t}function Ft(i){let e=pt(i.toDataURL());return{width:i.width,height:i.height,buffer:e}}function Bt(i){let e=pt(i);return{mimeType:i.split(";")[0].split(":")[1],buffer:e}}function E(i){if(typeof i=="string"&&i.startsWith("data:"))return Bt(i);if(typeof i=="string")return i;if(typeof i.src=="string")return i.src;if(typeof i.value<"u")return i.value;let t=i.baseTexture.resource;if(typeof t.data<"u")return{width:t.width,height:t.height,buffer:t.data};let r=t.source;if(r instanceof HTMLImageElement)return r.getAttribute("src");if(r instanceof HTMLCanvasElement)return Ft(r);throw console.error(i),new A}function Xt(i){let e=btoa(String.fromCharCode.apply(null,i.buffer));return PIXI.Texture.from(`data:${i.mimeType};base64,${e}`)}function Ut(i){return PIXI.Texture.fromBuffer(i.buffer,i.width,i.height)}function C(i){if(typeof i=="string"){let r=p(i);if(r)return r}let e=i;if(e.buffer&&e.mimeType)return Xt(e);let t=i;if(t.buffer&&t.width&&t.height)return Ut(t);throw new A}function _(...i){console.log(We,"Battle Transitions",...i)}function mt(i){i.push({name:"BATTLETRANSITIONS.NAVIGATION.TRIGGER",icon:'<i class="fas icon fa-fw crossed-swords"></i>',condition:e=>{let t=game.scenes?.get(e.data("sceneId")),r=t?.getFlag("battle-transitions","steps")??[];return game.users?.current&&t?.canUserModify(game.users?.current,"update")&&!t.active&&r.length},callback:e=>{let t=e.data("sceneId");if(!t)throw new x(typeof t=="string"?t:typeof t);let r=game.scenes?.get(t);if(!(r instanceof Scene))throw new x(typeof t=="string"?t:typeof t);let o=r.getFlag("battle-transitions","steps")??[];o.length&&L.transition(t,o)}})}function T(){return{none:"BATTLETRANSITIONS.EASINGS.NONE",power1in:"BATTLETRANSITIONS.EASINGS.POWER1IN",power1out:"BATTLETRANSITIONS.EASINGS.POWER1OUT",power1inout:"BATTLETRANSITIONS.EASINGS.POWER1INOUT",power2in:"BATTLETRANSITIONS.EASINGS.POWER2IN",power2out:"BATTLETRANSITIONS.EASINGS.POWER2OUT",power2inout:"BATTLETRANSITIONS.EASINGS.POWER2INOUT",power3in:"BATTLETRANSITIONS.EASINGS.POWER3IN",power3out:"BATTLETRANSITIONS.EASINGS.POWER3OUT",power3inout:"BATTLETRANSITIONS.EASINGS.POWER3INOUT",power4in:"BATTLETRANSITIONS.EASINGS.POWER4IN",power4out:"BATTLETRANSITIONS.EASINGS.POWER4OUT",power4inout:"BATTLETRANSITIONS.EASINGS.POWER4INOUT",backin:"BATTLETRANSITIONS.EASINGS.BACKIN",backout:"BATTLETRANSITIONS.EASINGS.BACKOUT",backinout:"BATTLETRANSITIONS.EASINGS.BACKINOUT",bouncein:"BATTLETRANSITIONS.EASINGS.BOUNCEIN",bounceout:"BATTLETRANSITIONS.EASINGS.BOUNCEOUT",bounceinout:"BATTLETRANSITIONS.EASINGS.BOUNCEINOUT",circin:"BATTLETRANSITIONS.EASINGS.CIRCIN",circout:"BATTLETRANSITIONS.EASINGS.CIRCOUT",circinout:"BATTLETRANSITIONS.EASINGS.CIRCINOUT",elasticin:"BATTLETRANSITIONS.EASINGS.ELASTICIN",elasticout:"BATTLETRANSITIONS.EASINGS.ELASTICOUT",elasticinout:"BATTLETRANSITIONS.EASINGS.ELASTICINOUT",expoin:"BATTLETRANSITIONS.EASINGS.EXPOIN",expoout:"BATTLETRANSITIONS.EASINGS.EXPOOUT",expoinout:"BATTLETRANSITIONS.EASINGS.EXPOINOUT",sinein:"BATTLETRANSITIONS.EASINGS.SINEIN",sineout:"BATTLETRANSITIONS.EASINGS.SINEOUT",sineinout:"BATTLETRANSITIONS.EASINGS.SINEINOUT"}}function m(i,...e){let t=i.serializeArray(),r=e.reduce((o,n)=>({...o,[n]:t.reduce((s,u)=>u.name===n?n==="id"&&!u.value?foundry.utils.randomID():u.value:s,"")}),{});return console.log("Parsed:",r),r}var w=document.createElement("div");w.style.display="none";w.style.position="absolute";w.style.width="100%";w.style.height="100%";w.id=Me;document.body.appendChild(w);var Te=null;function dt(){Te=new q,canvas?.stage?.addChild(Te)}async function Ht(){if(!canvas)throw new ee;if(!(canvas.app&&canvas.hidden&&canvas.primary&&canvas.tiles&&canvas.drawings&&canvas.scene&&canvas.stage))throw new ce;let{sceneWidth:i,sceneHeight:e}=canvas.scene.dimensions,t=canvas.app.renderer,r=PIXI.RenderTexture.create({width:i,height:e});t.render(canvas.stage,{renderTexture:r,skipUpdateTransform:!0,clear:!0});let o=document.getElementById(Me);if(!o)throw new ue;o.style.backgroundImage="";let n=Date.now(),s=await t.extract.image(r),u=document.createElement("canvas"),f=u.getContext("2d");if(!f)throw new y;u.width=s.width,u.height=s.height,f.fillStyle=t.background.backgroundColor.toHex(),f.fillRect(0,0,u.width,u.height),f.drawImage(s,0,0);let b=u.toDataURL();return _(`Image transfered in ${Date.now()-n}ms`),o.style.backgroundImage=`url(${b})`,o.style.backgroundColor=t.background.backgroundColor.toHex(),o.style.display="block",PIXI.Sprite.from(r)}async function st(){if(!Te)throw new y;let i=await Ht(),e=new PIXI.Container,t=l(canvas?.app?.renderer.background.backgroundColor??"white"),r=new PIXI.Sprite(t);return r.width=window.innerWidth,r.height=window.innerHeight,e.addChild(r),e.addChild(i),Te.addChild(e),e}function Be(i){if(w.style.display="none",w.style.backgroundImage="",i){if(Array.isArray(i.children)&&i.children.length)for(let e=i.children.length-1;e>=0;e--)i.children[e].destroy();i.destroy()}}function at(){let i=document.getElementById("loading");i&&(i.style.opacity="0")}function ut(){let i=document.getElementById("loading");i&&i.style.removeProperty("opacity")}function ct(){w.style.display="none",w.style.removeProperty("backgroundImage")}async function lt(i){let e=re(i);if(!(e instanceof Scene))throw new x(typeof i=="string"?i:"[Object object]");return await e.setFlag("battle-transitions","autoTriggered",!0),e.activate(),await de("canvasReady"),e}function ft(){Handlebars.registerHelper("switch",function(i,e){this._switch_value_=i;let t=e.fn(this);return delete this._switch_value_,t}),Handlebars.registerHelper("case",function(i,e){if(i==this._switch_value_)return e.fn(this)})}async function Tt(){return loadTemplates(["/modules/battle-transitions/templates/scene-config.hbs",...["add-step","fade-config","linearwipe-config","step-item"].map(i=>`/modules/battle-transitions/templates/config/${i}.hbs`)])}var ge=class{get key(){return"fade"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.FADE"}defaultSettings={duration:1e3,background:"#00000000"};generateSummary(e){return e?[a("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:e.duration}),e.background].join("; "):""}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/fade-config.hbs",{...this.defaultSettings,...e,easingSelect:T()})}createFlagFromHTML(e){return{...this.defaultSettings,...m($(e).find("form"),"id","duration","background","easing")}}};var Ie=class{defaultSettings={duration:1e3,background:"#00000000",direction:"left"};generateSummary(e){let t={...this.defaultSettings,...e};return[t.direction,t.duration,t.background].join("; ")}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/linearwipe-config.hbs",{...this.defaultSettings,...e,directionSelect:{top:"BATTLETRANSITIONS.DIRECTIONS.TOP",left:"BATTLETRANSITIONS.DIRECTIONS.LEFT",right:"BATTLETRANSITIONS.DIRECTIONS.RIGHT",bottom:"BATTLETRANSITIONS.DIRECTIONS.BOTTOM",topleft:"BATTLETRANSITIONS.DIRECTIONS.TOPLEFT",topright:"BATTLETRANSITIONS.DIRECTIONS.TOPRIGHT",bottomleft:"BATTLETRANSITIONS.DIRECTIONS.BOTTOMLEFT",bottomright:"BATTLETRANSITIONS.DIRECTIONS.BOTTOMRIGHT"},easingSelect:T()})}createFlagFromHTML(e){return{...this.defaultSettings,...m($(e).find("form"),"id","duration","direction","background","easing")}}get key(){return"linearwipe"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.LINEARWIPE"}};var Se=class{get key(){return"bilinearwipe"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.BILINEARWIPE"}defaultSettings={duration:1e3,direction:"horizontal",radial:"inside",background:"#00000000"};generateSummary(e){return e?[a("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:e.duration}),e.direction,e.radial,e.background].join("; "):""}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/bilinear-wipe-config.hbs",{...this.defaultSettings,...e,directionSelect:{horizontal:"BATTLETRANSITIONS.DIRECTIONS.HORIZONTAL",vertical:"BATTLETRANSITIONS.DIRECTIONS.VERTICAL",topleft:"BATTLETRANSITIONS.DIRECTIONS.TOPLEFT",topright:"BATTLETRANSITIONS.DIRECTIONS.TOPRIGHT"},radialSelect:{inside:"BATTLETRANSITIONS.DIRECTIONS.INSIDE",outside:"BATTLETRANSITIONS.DIRECTIONS.OUTSIDE"},easingSelect:T()})}createFlagFromHTML(e){return{...this.defaultSettings,...m($(e).find("form"),"duration","background","direction","radial","easing","id")}}};var he=class{get key(){return"chromakey"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.CHROMAKEY"}defaultSettings={keyColor:"#00b140",background:"#00000000"};generateSummary(e){let t={...this.defaultSettings,...e};return[t.keyColor,t.background].join("; ")}async renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/chromakey-config.hbs",{...this.defaultSettings,...e})}createFlagFromHTML(e){let t=$(e).find("form").serializeArray(),r=t.find(n=>n.name==="key-color"),o=t.find(n=>n.name==="background");return{...this.defaultSettings,...r?{keyColor:r.value}:{},...o?{background:o.value}:{}}}};var be=class{get key(){return"clockwipe"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.CLOCKWIPE"}defaultSettings={direction:"top",clockdirection:"clockwise",duration:1e3,background:"#00000000"};generateSummary(e){let t={...this.defaultSettings,...e};return[t.clockdirection,t.direction,a("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:t.duration}),t.background].join("; ")}async renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/clockwipe-config.hbs",{...this.defaultSettings,...e,directionSelect:{top:"BATTLETRANSITIONS.DIRECTIONS.TOP",left:"BATTLETRANSITIONS.DIRECTIONS.LEFT",right:"BATTLETRANSITIONS.DIRECTIONS.RIGHT",bottom:"BATTLETRANSITIONS.DIRECTIONS.BOTTOM"},clockDirectionSelect:{clockwise:"BATTLETRANSITIONS.DIRECTIONS.CLOCKWISE",counterclockwise:"BATTLETRANSITIONS.DIRECTIONS.COUNTERCLOCKWISE"},easingSelect:T()})}createFlagFromHTML(e){return{...this.defaultSettings,...m($(e).find("form"),"id","duration","direction","background","clockdirection","easing")}}};var xe=class{get key(){return"diamondwipe"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.DIAMOND"}defaultSettings={duration:1e3,size:40,background:"#00000000"};generateSummary(e){let t={...this.defaultSettings,...e};return[a("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:t.duration}),a("BATTLETRANSITIONS.FORMATTERS.PIXELS",{value:t.size}),t.background].join("; ")}async renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/diamond-config.hbs",{...this.defaultSettings,...e,easingSelect:T()})}createFlagFromHTML(e){return{...this.defaultSettings,...m($(e).find("form"),"id","duration","size","easing")}}};var Ee=class{get key(){return"firedissolve"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.FIREDISSOLVE"}defaultSettings={duration:1e3,background:"#00000000",burnSize:1.3};generateSummary(e){let t={...this.defaultSettings,...e};return[a("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:t.duration}),t.background].join("; ")}async renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/fire-dissolve-config.hbs",{...this.defaultSettings,...e,easingSelect:T()})}createFlagFromHTML(e){return{...this.defaultSettings,...m($(e).find("form"),"id","duration","background","burnsize","easing")}}};var Ce=class{get key(){return"radialwipe"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.RADIALWIPE"}defaultSettings={duration:1e3,background:"#00000000",radial:"inside"};generateSummary(e){let t={...this.defaultSettings,...e};return[a("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:t.duration}),t.radial,t.background].join("; ")}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/radial-wipe-config.hbs",{...e,radialOptions:{inside:"BATTLETRANSITIONS.DIRECTIONS.INSIDE",outside:"BATTLETRANSITIONS.DIRECTIONS.OUTSIDE"},easingSelect:T()})}createFlagFromHTML(e){return{...this.defaultSettings,...m($(e).find("form"),"id","duration","radial","background","easing")}}};var Ne=class{get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.SPOTLIGHTWIPE"}get key(){return"spotlightwipe"}defaultSettings={duration:1e3,background:"#00000000",direction:"top",radial:"outside"};generateSummary(e){let t={...this.defaultSettings,...e};return[a("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:t.duration}),t.direction,t.radial,t.background].join("; ")}createFlagFromHTML(e){return{...this.defaultSettings,...m($(e).find("form"),"id","duration","direction","radial","background","easing")}}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/spotlight-wipe-config.hbs",{...e,directionSelect:{top:"BATTLETRANSITIONS.DIRECTIONS.TOP",left:"BATTLETRANSITIONS.DIRECTIONS.LEFT",right:"BATTLETRANSITIONS.DIRECTIONS.RIGHT",bottom:"BATTLETRANSITIONS.DIRECTIONS.BOTTOM"},radialSelect:{inside:"BATTLETRANSITIONS.DIRECTIONS.INSIDE",outside:"BATTLETRANSITIONS.DIRECTIONS.OUTSIDE"},easingSelect:T()})}};var we=class{get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.TEXTURESWAP"}get key(){return"textureswap"}defaultSettings={texture:""};generateSummary(e){return[{...this.defaultSettings,...e}.texture.split("/").slice(-1)].join("; ")}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/texture-swap-config.hbs",{...this.defaultSettings,...e})}createFlagFromHTML(e){let r=$(e).find("form").serializeArray().find(n=>n.name==="id"),o=$(e).find("form #texture").val()??"";return{...this.defaultSettings,texture:o,id:r?r.value:foundry.utils.randomID()}}};var ye=class{get key(){return"wait"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.WAIT"}defaultSettings={duration:1e3};generateSummary(e){let t={...this.defaultSettings,...e};return a("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:t.duration})}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/wait-config.hbs",{...this.defaultSettings,...e})}createFlagFromHTML(e){return{...this.defaultSettings,...m($(e).find("form"),"id","duration")}}};var Ae=class{get key(){return"sound"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.SOUND"}defaultSettings={file:"",volume:100};generateSummary(e){let t={...this.defaultSettings,...e};return[t.file.split("/").slice(-1),a("BATTLETRANSITIONS.FORMATTERS.PERCENT",{value:t.volume*100})].join("; ")}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/sound-config.hbs",{...this.defaultSettings,...e})}createFlagFromHTML(e){let t=$(e).find("form").serializeArray(),r=$(e).find("form #file").val()??"",o=t.find(s=>s.name==="volume"),n=t.find(s=>s.name==="id");return{...this.defaultSettings,...r?{file:r}:{},...o?{volume:parseFloat(o.value)}:{},id:n?n.value:foundry.utils.randomID()}}};var ve=class{get key(){return"video"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.VIDEO"}defaultSettings={file:"",background:"#00000000",volume:1};generateSummary(e){let t={...this.defaultSettings,...e};return[t.file.split("/").splice(-1),a("BATTLETRANSITIONS.FORMATTERS.PERCENT",{value:t.volume*100})].join("; ")}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/video-config.hbs",{...this.defaultSettings,...e,volume:(e?.volume!==void 0?e.volume:this.defaultSettings.volume)*100})}createFlagFromHTML(e){let t=$(e).find("form #file").val()??"",r=$(e).find("form #volume input[type='number']").val();return{...this.defaultSettings,...t?{file:t}:{},...r?{volume:r/100}:{},...m($(e).find("form"),"id","background")}}};new he;var j=[new ge,new Ie,new Se,new be,new xe,new Ee,new Ce,new Ne,new we,new ye,new Ae,new ve].sort((i,e)=>a(i.name).localeCompare(a(e.name))),Oe=class{#e;#r;#t=null;stepKey="steps";configKey="config";tabName="battle-transitions";icon=["fas","crossed-swords","fa-fw","icon"];get appId(){return this.#e.appId}get rootElement(){return $(this.#e.element)}get addStepDialogElement(){return this.#t?$(this.#t.element):null}updateConfiguration(){let e=[];this.rootElement.find(".step-config-item[data-transition-type]").each((o,n)=>{let s=$(n).data("flag"),u=$(n).data("transition-type");if(!u||typeof u!="string"||typeof s!="object")throw new h("");e.push({...s,type:u})});let r={autoTrigger:this.rootElement.find('[data-tab="battle-transitions"]').find("input#auto-trigger").is(":checked")};Promise.all([this.#r.setFlag("battle-transitions",this.stepKey,e),this.#r.setFlag("battle-transitions",this.configKey,r)])}addEventListeners(){this.rootElement.find("button[data-action='add-step']").on("click",e=>{if($(e.currentTarget).is(":focus"))return this.onAddStep(e)}),this.rootElement.find("#transition-step-list").sortable({handle:".drag-handle",containment:"parent",axis:"y"}),this.rootElement.find("button[type='submit']").on("click",()=>{this.updateConfiguration()}),ColorPicker.install()}onAddStep(e){e.preventDefault(),fe()&&foundry.applications.api.DialogV2?this.addStepDialogV2():this.addStepDialog()}resizeDialog(){this.rootElement.find(".item.active[data-tab]").data("tab")===this.tabName&&(this.#e.activateTab("basic"),this.#e.activateTab(this.tabName))}addStepEventListeners(e,t={}){e.find("[data-action='remove']").on("click",()=>{let r=e.data("transition-type")??"",o=j.find(n=>n.key===r);if(!o)throw new h(r);fe()&&foundry.applications.api.DialogV2?foundry.applications.api.DialogV2.confirm({content:a("BATTLETRANSITIONS.SCENECONFIG.REMOVECONFIRM",{name:a(o.name)})}).then(n=>{n&&(e.remove(),this.resizeDialog())}):Dialog.confirm({content:a("BATTLETRANSITIONS.SCENECONFIG.REMOVECONFIRM",{name:a(o.name)})}).then(n=>{n&&(e.remove(),this.resizeDialog())})}),e.find("[data-action='configure']").on("click",()=>{let r=e.data("transition-type")??"",o=j.find(s=>s.key===r);if(!o)throw new h(r);let n=e.data("flag")??o.defaultSettings;this.configureStep(r,n)})}addConfigureStepEventListeners(e,t={}){e.find("input[type='text'],input[type='number']").on("focus",r=>{r.currentTarget.select()}),ColorPicker.install()}async configureStep(e,t={}){let r=j.find(n=>n.key===e);if(!r)throw new h(e);let o=await r.renderTemplate(t);fe()&&foundry.applications.api.DialogV2?foundry.applications.api.DialogV2.wait({window:{title:a("BATTLETRANSITIONS.SCENECONFIG.EDITSTEPDIALOG.TITLE",{name:a(r.name)})},content:o,render:(n,s)=>{this.addConfigureStepEventListeners($(s),t)},buttons:[{label:"<i class='fas fa-times'></i> "+a("BATTLETRANSITIONS.DIALOGS.BUTTONS.CANCEL"),action:"cancel"},{label:"<i class='fas fa-check'></i> "+a("BATTLETRANSITIONS.DIALOGS.BUTTONS.OK"),action:"ok",default:!0,callback:async(n,s,u)=>{let f=r.createFlagFromHTML($(u));this.addUpdateTransitionStep(e,f)}}]}):await Dialog.wait({title:a("BATTLETRANSITIONS.SCENECONFIG.EDITSTEPDIALOG.TITLE",{name:a(r.name)}),content:o,render:n=>{this.addConfigureStepEventListeners(n,t)},default:"ok",buttons:{cancel:{icon:"<i class='fas fa-times'></i>",label:a("BATTLETRANSITIONS.DIALOGS.BUTTONS.CANCEL")},ok:{icon:"<i class='fas fa-check'></i>",label:a("BATTLETRANSITIONS.DIALOGS.BUTTONS.OK"),callback:n=>{let s=r.createFlagFromHTML(n);this.addUpdateTransitionStep(e,s)}}}})}async addUpdateTransitionStep(e,t={}){let r=j.find(u=>u.key===e);if(!r)throw new h(e);t.id||(t.id=foundry.utils.randomID());let o=await renderTemplate("/modules/battle-transitions/templates/config/step-item.hbs",{...t??{},name:a(r?.name),summary:r.generateSummary(t),type:e,flag:JSON.stringify(t)}),n=$(o),s=this.rootElement.find(`[data-id="${t.id}"]`);s.length?s.replaceWith(n):this.rootElement.find("#transition-step-list").append(n),this.addStepEventListeners(n,t),this.resizeDialog(),ColorPicker.install()}async getRenderedDialogTemplate(){return renderTemplate("/modules/battle-transitions/templates/config/add-step.hbs",{transitionTypes:j.map(e=>({key:e.key,name:e.name}))})}onAddStepDialogRender(){if(!this.addStepDialogElement)throw new ae;this.addStepDialogElement.find("#add-step-form button[data-transition]").on("click",e=>{e.preventDefault();let t=e.currentTarget.dataset.transition??"";this.#t?.close();let r=j.find(o=>o.key===t);if(!r)throw new h(t);this.configureStep(t,r.defaultSettings)})}async addStepDialog(){let e=await this.getRenderedDialogTemplate(),t=new Dialog({title:a("BATTLETRANSITIONS.SCENECONFIG.ADDSTEPDIALOG.TITLE"),content:e,render:()=>{this.onAddStepDialogRender()},buttons:{cancel:{label:a("BATTLETRANSITIONS.DIALOGS.BUTTONS.CANCEL"),icon:"<i class='fas fa-times'></i>"}}});this.#t=t,t.render(!0)}async addStepDialogV2(){let e=await this.getRenderedDialogTemplate();foundry.applications.api.DialogV2.wait({window:{title:"BATTLETRANSITIONS.SCENECONFIG.ADDSTEPDIALOG.TITLE"},rejectClose:!1,render:t=>{this.#t=t.target,this.onAddStepDialogRender()},content:e,buttons:[{label:"<i class='fas fa-times'></i> "+a("BATTLETRANSITIONS.DIALOGS.BUTTONS.CANCEL"),action:"cancel"}]}).then(t=>t==="cancel"?null:t)}async inject(){return game.release?.isNewer("12")?this.injectV12():this.injectV11()}async injectV11(){let e=this.rootElement.find("nav.sheet-tabs.tabs"),t=document.createElement("a");t.classList.add("item"),t.dataset.tab=this.tabName;let r=document.createElement("i");r.classList.add(...this.icon),t.appendChild(r),t.innerHTML+=" "+a("BATTLETRANSITIONS.SCENECONFIG.TAB"),e.append(t);let o=this.#r.getFlag("battle-transitions",this.configKey),n=await renderTemplate("/modules/battle-transitions/templates/scene-config.hbs",o);this.rootElement.find("button[type='submit']").before(`<div class="tab" data-tab="${this.tabName}">${n}</div>`);let s=this.#r.getFlag("battle-transitions",this.stepKey);if(Array.isArray(s))for(let u of s)await this.addUpdateTransitionStep(u.type,u);this.addEventListeners()}async injectV12(){let e=this.rootElement.find("nav.sheet-tabs.tabs[data-group='main']"),t=document.createElement("a");t.classList.add("item"),t.dataset.tab=this.tabName;let r=document.createElement("i");r.classList.add(...this.icon),t.appendChild(r),t.innerHTML+=" "+a("BATTLETRANSITIONS.SCENECONFIG.TAB"),e.append(t);let o=this.#r.getFlag("battle-transitions",this.configKey),n=await renderTemplate("/modules/battle-transitions/templates/scene-config.hbs",o);this.rootElement.find("footer.sheet-footer").before(`<div class="tab" data-group="main" data-tab="${this.tabName}">${n}</div>`);let s=this.#r.getFlag("battle-transitions",this.stepKey);if(Array.isArray(s))for(let u of s)await this.addUpdateTransitionStep(u.type,u);this.addEventListeners()}constructor(e,t){this.#e=e,this.#r=t,this.inject()}};window.BattleTransition=G;Hooks.once("canvasReady",()=>{dt(),Hooks.callAll(ze.INITIALIZE)});Hooks.on("renderSceneConfig",i=>{new Oe(i,i.object)});Hooks.once("init",async()=>{ft(),await Tt()});Hooks.once("socketlib.ready",()=>{L.register(socketlib.registerModule("battle-transitions"))});Hooks.on("getSceneNavigationContext",(i,e)=>{mt(e)});Hooks.on("preUpdateScene",(i,e,t,r)=>{if(e.active&&!(i.getFlag("battle-transitions","autoTriggered")??!1)){let o=i.getFlag("battle-transitions","config"),n=i.getFlag("battle-transitions","steps");o?.autoTrigger&&n?.length&&(e.active=!1,L.transition(i.id,n))}});Hooks.on("updateScene",async(i,e,t,r)=>{e.active&&(i.getFlag("battle-transitions","autoTriggered")??!1)&&i.canUserModify(game.users?.current,"update")&&await i.setFlag("battle-transitions","autoTriggered",!1)});})();
