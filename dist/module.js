"use strict";(()=>{var ke="transition-cover",Xe="BATTLETRANSITIONS",He="\u2694\uFE0F",Ue={INITIALIZE:"battle-transitions.init",TRANSITION_START:"battle-transitions.transitionStart",TRANSITION_END:"battle-transitions.transitionEnd"};var Y=class extends PIXI.Container{setInverseMatrix(){canvas?.app?.stage&&this.transform.setFromMatrix(canvas.app.stage.localTransform.clone().invert())}constructor(){super(),this.interactiveChildren=!1,this.interactive=!1,this.eventMode="none",canvas?.app&&canvas.app.renderer.addListener("prerender",()=>{this.setInverseMatrix()})}};var u=class extends Error{constructor(e,t){e?super(game.i18n?.format(`${Xe}.ERRORS.${e}`,t)):super()}};var y=class extends u{constructor(){super("CANNOTINITIALIZECANVAS")}};var Z=class extends u{constructor(){super("CANVASNOTFOUND")}};var oe=class extends u{constructor(e){super("FILENOTFOUND",{file:e})}};var h=class extends u{constructor(e){super("INVALIDDIRECTION",{direction:e})}};var ae=class extends u{constructor(){super("INVALIDELEMENT")}};var q=class extends u{constructor(e){super("INVALIDMACRO",{macro:e})}};var x=class extends u{constructor(e){super("INVALIDSCENE",{name:e})}};var D=class extends u{constructor(){super("INVALIDTEXTURE")}};var b=class extends u{constructor(e){super("INVALIDTRANSITION",{name:e})}};var se=class extends u{constructor(){super("NOCOVERELEMENT")}};var ce=class extends u{constructor(){super("NOTINITIALIZED")}};var ue=class extends u{constructor(){super("EXECUTECALLEDPARALLEL")}};var le=class extends u{constructor(){super("PERMISSIONDENIED")}};var pe=class extends u{constructor(){super("TRANSITIONTOSELF")}};function ft(i){try{return new PIXI.Color(i)}catch{}}function d(i){let e=ft(i);if(e)return l(e);try{return PIXI.Texture.from(i)}catch{}}function ee(i){if(game instanceof Game&&game.scenes){if(typeof i=="string"){let e=game.scenes.get(i);if(e||(e=game.scenes.getName(i),e))return e}else if(i instanceof Scene)return i}}function Fe(i){if(i instanceof Macro)return i;if(game.macros&&typeof i=="string"){let e=game.macros?.get(i);if(e||(e=game.macros?.getName(i),e))return e;if(i.split(".")[0]==="Macro")return game.macros?.get(i.split(".").slice(1).join("."))}}var Ge=Math.sqrt(3),$e=Math.sqrt(5),Tt=.5*(Ge-1),te=(3-Ge)/6,Br=1/3,Xr=1/6,Hr=($e-1)/4,Ur=(5-$e)/20,We=i=>Math.floor(i)|0,ze=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function je(i=Math.random){let e=gt(i),t=new Float64Array(e).map(n=>ze[n%12*2]),r=new Float64Array(e).map(n=>ze[n%12*2+1]);return function(o,a){let c=0,m=0,E=0,g=(o+a)*Tt,S=We(o+g),v=We(a+g),re=(S+v)*te,dt=S-re,mt=v-re,_=o-dt,P=a-mt,ie,ne;_>P?(ie=1,ne=0):(ie=0,ne=1);let Le=_-ie+te,ve=P-ne+te,De=_-1+2*te,Re=P-1+2*te,_e=S&255,Pe=v&255,j=.5-_*_-P*P;if(j>=0){let O=_e+e[Pe],Q=t[O],J=r[O];j*=j,c=j*j*(Q*_+J*P)}let V=.5-Le*Le-ve*ve;if(V>=0){let O=_e+ie+e[Pe+ne],Q=t[O],J=r[O];V*=V,m=V*V*(Q*Le+J*ve)}let K=.5-De*De-Re*Re;if(K>=0){let O=_e+1+e[Pe+1],Q=t[O],J=r[O];K*=K,E=K*K*(Q*De+J*Re)}return 70*(c+m+E)}}function gt(i){let t=new Uint8Array(512);for(let r=0;r<512/2;r++)t[r]=r;for(let r=0;r<512/2-1;r++){let n=r+~~(i()*(256-r)),o=t[r];t[r]=t[n],t[n]=o}for(let r=256;r<512;r++)t[r]=t[r-256];return t}var Ve=`precision highp float;

uniform sampler2D uSampler;
in vec2 vTextureCoord;
out vec4 color;

void main() {
    color = texture(uSampler, vTextureCoord);
}`;var Ke=`in vec2 aVertexPosition;

uniform mat3 projectionMatrix;

out vec2 vTextureCoord;

uniform vec4 inputSize;
uniform vec4 outputFrame;

vec4 filterVertexPosition(void) {
    vec2 position = aVertexPosition * max(outputFrame.zw, vec2(0.)) + outputFrame.xy;
    
    return vec4((projectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);
}

vec2 filterTextureCoord(void) {
    return aVertexPosition * (outputFrame.zw * inputSize.zw);
}

void main(void) {
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`;var T=class extends PIXI.Filter{constructor(e,t,r){super(e||Ke,t||Ve,r),this.program.fragmentSrc.includes("#version 300 es")||(this.program.fragmentSrc=`#version 300 es 
`+this.program.fragmentSrc),this.program.vertexSrc.includes("#version 300 es")||(this.program.vertexSrc=`#version 300 es
`+this.program.vertexSrc)}};var Qe=`precision highp float;

in vec2 vTextureCoord;
out vec4 color;

uniform sampler2D uSampler;
uniform sampler2D noise_texture;
uniform sampler2D burn_texture;

uniform float integrity;
uniform float burn_size;

float inverse_lerp(float a, float b, float v) {
    return (v - a) / (b - a);
}

void main() {
    float noise = texture(noise_texture, vTextureCoord).r * vTextureCoord.y;
    vec4 base_color = texture(uSampler, vTextureCoord) * step(noise, integrity);
    vec2 burn_uv = vec2(inverse_lerp(integrity, integrity * burn_size, noise), 0.0);
    vec4 burn_color = texture(burn_texture, burn_uv) * step(noise, integrity * burn_size);
    
    color = mix(burn_color, base_color, base_color.a);
    // color = texture(uSampler, vTextureCoord);
}`;var bt=Ye(1024,new PIXI.Color("#ff0400"),new PIXI.Color("#ffff01")),k=class extends T{constructor(e="transparent",t=1.3){let n={noise_texture:Je(),integrity:1,burn_size:t,burn_texture:bt};super(void 0,Qe,n)}};var Ze=`precision highp float;

uniform sampler2D uSampler;
in vec2 vTextureCoord;
out vec4 color;

uniform float progress;
uniform float size;
uniform vec2 screen_size;
uniform sampler2D bgSampler;

void main() {
    vec2 screenCoord = screen_size * vTextureCoord;
    
    float x = abs(fract(screenCoord.x / size) - 0.5);
    float y = abs(fract(screenCoord.y / size) - 0.5);
    
    if (x + y + vTextureCoord.x > progress * 2.0) {
        color = texture(uSampler, vTextureCoord);
    } else {
        color = texture(bgSampler, vTextureCoord);
    }
}`;var F=class extends T{constructor(e,t="transparent"){let r=d(t)??l("transparent");super(void 0,Ze,{progress:0,size:e,bgSampler:r,screen_size:{x:window.innerWidth,y:window.innerHeight}})}};var qe=`precision highp float;

uniform sampler2D uSampler;
in vec2 vTextureCoord;
out vec4 color;

uniform float progress;
uniform sampler2D wipeSampler;
uniform sampler2D bgSampler;

void main() {
    vec4 wipe = texture(wipeSampler, vTextureCoord);
    
    if (wipe.b < progress) {
        color = texture(bgSampler, vTextureCoord);
    } else {
        color = texture(uSampler, vTextureCoord);
    }
}`;var Ct=l(new PIXI.Color("#00000000")),I=class extends T{constructor(e,t){let r={progress:0,wipeSampler:e,bgSampler:t??Ct};super(void 0,qe,r)}};var et=`precision highp float;

uniform sampler2D uSampler;
in vec2 vTextureCoord;
out vec4 color;

uniform float progress;
uniform sampler2D bgColor;

void main() {
    color = mix(texture(uSampler, vTextureCoord), texture(bgColor, vTextureCoord), progress);
}`;var M=class extends T{constructor(e="transparent"){let t=d(e)??l("transparent");super(void 0,et,{bgColor:t,progress:0})}};var Nt={horizontal:{inside:"bilinear-horizontal-inside.webp",outside:"bilinear-horizontal-outside.webp"},vertical:{inside:"bilinear-vertical-inside.webp",outside:"bilinear-vertical-outside.webp"},topleft:{inside:"bilinear-top-left-inside.webp",outside:"bilinear-top-right-outside.webp"},topright:{inside:"bilinear-top-right-inside.webp",outside:"bilinear-top-right-outside.webp"},bottomleft:{inside:"bilinear-top-right-inside.webp",outside:"bilinear-top-right-outside.webp"},bottomright:{inside:"bilinear-top-left-inside.webp",outside:"bilinear-top-right-outside.webp"}},B=class extends I{constructor(e,t,r){let n=d(r)??l("transparent"),o=Nt[e]?.[t];if(!o)throw new h(`${e}-${t}`);let a=PIXI.Texture.from(`/modules/battle-transitions/assets/wipes/${o}`);super(a,n)}};var yt={left:"linear-left.webp",right:"linear-right.webp",top:"linear-top.webp",bottom:"linear-bottom.webp",topleft:"linear-top-left.webp",topright:"linear-top-right.webp",bottomleft:"linear-bottom-left.webp",bottomright:"linear-bottom-right.webp"},X=class extends I{constructor(e,t){let r=d(t)??l("transparent"),n=yt[e];if(!n)throw new h(e);let o=PIXI.Texture.from(`/modules/battle-transitions/assets/wipes/${n}`);super(o,r)}};var At={clockwise:{top:"clockwise-top.webp",left:"clockwise-left.webp",right:"clockwise-right.webp",bottom:"clockwise-bottom.webp"},counterclockwise:{top:"anticlockwise-top.webp",left:"anticlockwise-left.webp",right:"anticlockwise-right.webp",bottom:"anticlockwise-bottom.webp"}},H=class extends I{constructor(e,t,r){let n=d(r)??l("transparent"),o=At[e]?.[t];if(!o)throw new h(`${e}-${t}`);let a=PIXI.Texture.from(`/modules/battle-transitions/assets/wipes/${o}`);super(a,n)}};var Ot={left:{inside:"spotlight-left-inside.webp",outside:"spotlight-right-outside.webp"},top:{inside:"spotlight-top-inside.webp",outside:"spotlight-top-outside.webp"},right:{inside:"spotlight-right-inside.webp",outside:"spotlight-right-outside.webp"},bottom:{inside:"spotlight-bottom-inside.webp",outside:"spotlgiht-bottom-outside.webp"}},U=class extends I{constructor(e,t,r="transparent"){let n=d(r)??l("transparent"),o=Ot[e]?.[t];if(!o)throw new h(`${e}-${t}`);let a=PIXI.Texture.from(`/modules/battle-transitions/assets/wipes/${o}`);super(a,n)}};var Lt={inside:"radial-inside.webp",outside:"radial-outside.webp"},W=class extends I{constructor(e,t){let r=d(t)??l("transparent"),n=Lt[e];if(!n)throw new h(e);let o=PIXI.Texture.from(`/modules/battle-transitions/assets/wipes/${n}`);super(o,r)}};var tt=`precision highp float;

uniform sampler2D uSampler;
in vec2 vTextureCoord;
out vec4 color;

uniform sampler2D uTexture;

void main() {
    color = texture(uTexture, vTextureCoord);
}`;var R=class extends T{constructor(e){let t=d(e);if(!t)throw new D;super(void 0,tt,{uTexture:t})}};var z=class i{#r=[];#e="none";#i=null;#t=[];#c=[];#n=[];#o={bilinearwipe:this.#l.bind(this),clockwipe:this.#d.bind(this),diamondwipe:this.#m.bind(this),fade:this.#f.bind(this),firedissolve:this.#p.bind(this),linearwipe:this.#T.bind(this),macro:this.#g.bind(this),parallel:this.#I.bind(this),radialwipe:this.#S.bind(this),removeoverlay:this.#h.bind(this),spotlightwipe:this.#E.bind(this),textureswap:this.#x.bind(this),sound:this.#b.bind(this),video:this.#C.bind(this),wait:this.#w.bind(this)};#a={video:this.#N.bind(this)};constructor(e){try{if(e){let t=ee(e);if(!t)throw new x(e);this.#i=t}}catch(t){throw ui.notifications?.error(t.message),t}}get sequence(){return this.#t}static Cleanup(){Me()}static async SelectScene(){let e=await renderTemplate("/modules/battle-transitions/templates/scene-selector.hbs",{scenes:game.scenes?.contents.map(t=>({id:t.id,name:t.name}))});return Dialog.wait({title:s("BATTLETRANSITIONS.SCENESELECTOR.TITLE"),content:e,default:"ok",buttons:{cancel:{icon:"<i class='fas fa-times'></i>",label:s("BATTLETRANSITIONS.DIALOGS.BUTTONS.CANCEL"),callback:()=>null},ok:{icon:"<i class='fas fa-check'></i>",label:s("BATTLETRANSITIONS.DIALOGS.BUTTONS.OK"),callback:t=>game.scenes?.get($(t).find("#scene").val())??null}}})}static TriggerForScene(e){let t=ee(e);if(!t)throw new x(typeof e=="string"?e:typeof e);let r=t.getFlag("battle-transitions","steps")??[];r.length&&L.transition(t.id??"",r)}bilinearWipe(e,t,r=1e3,n="transparent",o=this.#e){new B(e,t,n);let a=w(n);return this.#t.push({type:"bilinearwipe",duration:r,direction:e,radial:t,background:a,easing:o}),this}burn(e=1e3,t="transparent",r=1.3,n=this.#e){return new k(t,r),this.#t.push({type:"firedissolve",background:w(t),duration:e,burnSize:r,easing:n}),this}clockWipe(e,t,r=1e3,n="transparent",o=this.#e){return new H(e,t,n),this.#t.push({type:"clockwipe",duration:r,background:w(n),direction:t,clockdirection:e,easing:o}),this}diamondWipe(e,t=1e3,r="transparent",n=this.#e){return new F(e,r),this.#t.push({type:"diamondwipe",size:e,background:w(r),duration:t,easing:n}),this}async execute(e=!1,t,r){let n=null;try{if(!this.#i)throw new x("undefined");if(this.#i.id===canvas?.scene?.id)throw new pe;if(e){if(!t)throw new b(typeof t);n=await rt(),this.#n.push(...n.children),it(),r!==game.users?.current?.id?await de("canvasReady"):r===game.users?.current?.id&&await at(this.#i),nt(),ot(),await this.#u(t),await this.#s(t,n),Me(n)}else{if(!this.#i.canUserModify(game.users?.current??null,"update"))throw new le;L.transition(this.#i.id??"",t||this.#t)}}catch(o){ui.notifications?.error(o.message)}finally{n&&n.destroy()}}async#u(e){this.#r=[];for(let t of e)typeof this.#a[t.type]=="function"&&await this.#a[t.type](t)}fade(e,t="transparent",r=this.#e){return new M(t),this.#t.push({type:"fade",duration:e,background:w(t),easing:r}),this}linearWipe(e,t=1e3,r="transparent",n=this.#e){new X(e,r);let o=w(r);return this.#t.push({type:"linearwipe",duration:t,direction:e,background:o,easing:n}),this}macro(e){let t=Fe(e);if(!t)throw new q(typeof e=="string"?e:typeof e);return this.#t.push({type:"macro",macro:t.id}),this}parallel(...e){let t=[];for(let r of e){let n=new i;if(r(n)instanceof Promise)throw new ue;t.push(n.sequence)}return this.#t.push({type:"parallel",sequences:t}),this}radialWipe(e,t=1e3,r="transparent",n=this.#e){return new W(e,r),this.#t.push({type:"radialwipe",duration:t,radial:e,background:w(r),easing:n}),this}removeOverlay(){return this.#t.push({type:"removeoverlay"}),this}sound(e,t=100){return this.#t.push({type:"sound",file:typeof e=="string"?e:e.src,volume:t}),this}spotlightWipe(e,t,r=1e3,n="transparent",o=this.#e){return new U(e,t,n),this.#t.push({type:"spotlightwipe",direction:e,radial:t,duration:r,background:w(n),easing:o}),this}textureSwap(e){return new R(e),this.#t.push({type:"textureswap",texture:w(e)}),this}video(e,...t){let r=t.find(a=>typeof a=="number")??100,n=t.find(a=>typeof a=="boolean")??!1,o=t.find(a=>!(typeof a=="boolean"||typeof a=="number"))??"transparent";return this.#t.push({type:"video",file:e,volume:r,background:o,clear:n}),this}wait(e){return this.#t.push({type:"wait",duration:e}),this}async#l(e,t){let r=N(e.background),n=new B(e.direction,e.radial,r.baseTexture);Array.isArray(t.filters)?t.filters.push(n):t.filters=[n],await TweenMax.to(n.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#p(e,t){let r=new k(e.background,e.burnSize);Array.isArray(t.filters)?t.filters.push(r):t.filters=[r],await TweenMax.to(r.uniforms,{integrity:0,duration:e.duration/1e3,ease:e.easing||this.#e})}async#d(e,t){let r=N(e.background),n=new H(e.clockdirection,e.direction,r.baseTexture);Array.isArray(t.filters)?t.filters.push(n):t.filters=[n],await TweenMax.to(n.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#m(e,t){let r=N(e.background),n=new F(e.size,r.baseTexture);Array.isArray(t.filters)?t.filters.push(n):t.filters=[n],await TweenMax.to(n.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#f(e,t){let r=N(e.background),n=new M(r.baseTexture);Array.isArray(t.filters)?t.filters.push(n):t.filters=[n],await TweenMax.to(n.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#T(e,t){let r=N(e.background??l("transparent")),n=new X(e.direction,r.baseTexture);Array.isArray(t.filters)?t.filters.push(n):t.filters=[n],await TweenMax.to(n.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#g(e){let t=Fe(e.macro);if(!t)throw new q(e.macro);let r=t.execute();if(r instanceof Promise)await r;else return Promise.resolve()}async#I(e,t){await Promise.all(e.sequences.map(r=>this.#s(r,t)))}async#S(e,t){let r=N(e.background),n=new W(e.radial,r.baseTexture);Array.isArray(t.filters)?t.filters.push(n):t.filters=[n],await TweenMax.to(n.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#h(){return this.#n.forEach(e=>e.alpha=0),Promise.resolve()}async#s(e,t){for(let r of e){if(typeof this.#o[r.type]!="function")throw new b(r.type);let n=this.#o[r.type];typeof n=="function"&&await n(r,t)}}async#b(e){await foundry.audio.AudioHelper.preloadSound(e.file);let t=await foundry.audio.AudioHelper.play({src:e.file,volume:e.volume/100,autoplay:!0},!0);return this.#c.push(t),Promise.resolve()}async#E(e,t){let r=N(e.background),n=new U(e.direction,e.radial,r.baseTexture);Array.isArray(t.filters)?t.filters.push(n):t.filters=[n],await TweenMax.to(n.uniforms,{progress:1,duration:e.duration/1e3,ease:e.easing||this.#e})}async#x(e,t){let r=N(e.texture),n=new R(r.baseTexture);return Array.isArray(t.filters)?t.filters.push(n):t.filters=[n],Promise.resolve()}async#C(e,t){let r=this.#r.find(c=>c.path===e.file)?.texture;if(!r)throw new oe(e.file);A("Texture:",r);let n=N(e.background),a=r.baseTexture.resource.source;return new Promise((c,m)=>{let E=new R(r.baseTexture),g=PIXI.Sprite.from(r),S=PIXI.Sprite.from(n),v=new PIXI.Container;v.addChild(S),S.width=window.innerWidth,S.height=window.innerHeight,v.addChild(g),g.width=window.innerWidth,g.height=window.innerHeight,g.filters=[E],a.currentTime=0,t.addChild(v),a.addEventListener("ended",()=>{e.clear&&setTimeout(()=>{g.destroy()},500),c()}),a.addEventListener("error",re=>{m(re.error)}),a.play()})}async#w(e){return new Promise(t=>{setTimeout(t,e.duration)})}async#N(e){A(`Preloading ${e.file}...`);let t=Date.now(),r=await PIXI.loadVideo.load(e.file);this.#r.push({path:e.file,texture:r}),A(`Video loaded in ${Date.now()-t}ms`)}};var Be=class{#r;transition(e,t){this.#r.executeForEveryone("transition.exec",e,t,game.users?.current?.id??"")}_execute(e,t,r){A("Executing transition chain:",t),new z(e).execute(!0,t,r)}register(e){A("Registering socket:",e),this.#r=e,e.register("transition.exec",this._execute.bind(this))}},L=new Be;function Je(i=256,e=256,t){let r=je(t),n=document.createElement("canvas"),o=n.getContext("2d");if(!o)throw new y;n.width=i,n.height=e;let a=o.createImageData(n.width,n.height),c=a.data;for(let m=0;m<n.height;m++)for(let E=0;E<n.width;E++){let g=r(E/32,m/32),S=(m*n.width+E)*4;c[S]=g*255,c[S+1]=g*255,c[S+2]=g*255,c[S+3]=255}return o.putImageData(a,0,0),PIXI.Texture.from(n)}function Ye(i,e,t){let r=document.createElement("canvas");r.width=i,r.height=1;let n=r.getContext("2d");if(!n)throw new y;let o=n.createLinearGradient(0,0,i,0),a=e??new PIXI.Color("white"),c=t??new PIXI.Color("black");return o.addColorStop(0,a.toHex()),o.addColorStop(1,c.toHex()),n.fillStyle=o,n.fillRect(0,0,i,1),PIXI.Texture.from(r)}function l(i){let e=document.createElement("canvas");e.width=1,e.height=1;let t=e.getContext("2d");if(!t)throw new y;let r=new PIXI.Color(i);return t.fillStyle=r.toHexa(),t.fillRect(0,0,1,1),PIXI.Texture.from(e)}async function de(i){return new Promise(e=>{Hooks.once(i,(...t)=>{e(t)})})}function s(i,e={}){return game.i18n?.format(i,e)??i}function me(){return game.release?.isNewer("12")??!1}function st(i){let e=atob(i.split(",")[1]),t=new Uint8Array(e.length);for(let r=0;r<t.length;r++)t[r]=e.charCodeAt(r);return t}function Dt(i){let e=st(i.toDataURL());return{width:i.width,height:i.height,buffer:e}}function Rt(i){let e=st(i);return{mimeType:i.split(";")[0].split(":")[1],buffer:e}}function w(i){if(typeof i=="string"&&i.startsWith("data:"))return Rt(i);if(typeof i=="string")return i;if(typeof i.src=="string")return i.src;if(typeof i.value<"u")return i.value;let t=i.baseTexture.resource;if(typeof t.data<"u")return{width:t.width,height:t.height,buffer:t.data};let r=t.source;if(r instanceof HTMLImageElement)return r.getAttribute("src");if(r instanceof HTMLCanvasElement)return Dt(r);throw console.error(i),new D}function _t(i){let e=btoa(String.fromCharCode.apply(null,i.buffer));return PIXI.Texture.from(`data:${i.mimeType};base64,${e}`)}function Pt(i){return PIXI.Texture.fromBuffer(i.buffer,i.width,i.height)}function N(i){if(typeof i=="string"){let r=d(i);if(r)return r}let e=i;if(e.buffer&&e.mimeType)return _t(e);let t=i;if(t.buffer&&t.width&&t.height)return Pt(t);throw new D}function A(...i){console.log(He,"Battle Transitions",...i)}function ct(i){i.push({name:"BATTLETRANSITIONS.NAVIGATION.TRIGGER",icon:'<i class="fas bt-icon fa-fw crossed-swords"></i>',condition:e=>{let t=game.scenes?.get(e.data("sceneId")),r=t?.getFlag("battle-transitions","steps")??[];return game.users?.current&&t?.canUserModify(game.users?.current,"update")&&!t.active&&r.length},callback:e=>{let t=e.data("sceneId");if(!t)throw new x(typeof t=="string"?t:typeof t);let r=game.scenes?.get(t);if(!(r instanceof Scene))throw new x(typeof t=="string"?t:typeof t);let n=r.getFlag("battle-transitions","steps")??[];n.length&&L.transition(t,n)}})}function f(){return{none:"BATTLETRANSITIONS.EASINGS.NONE",power1in:"BATTLETRANSITIONS.EASINGS.POWER1IN",power1out:"BATTLETRANSITIONS.EASINGS.POWER1OUT",power1inout:"BATTLETRANSITIONS.EASINGS.POWER1INOUT",power2in:"BATTLETRANSITIONS.EASINGS.POWER2IN",power2out:"BATTLETRANSITIONS.EASINGS.POWER2OUT",power2inout:"BATTLETRANSITIONS.EASINGS.POWER2INOUT",power3in:"BATTLETRANSITIONS.EASINGS.POWER3IN",power3out:"BATTLETRANSITIONS.EASINGS.POWER3OUT",power3inout:"BATTLETRANSITIONS.EASINGS.POWER3INOUT",power4in:"BATTLETRANSITIONS.EASINGS.POWER4IN",power4out:"BATTLETRANSITIONS.EASINGS.POWER4OUT",power4inout:"BATTLETRANSITIONS.EASINGS.POWER4INOUT",backin:"BATTLETRANSITIONS.EASINGS.BACKIN",backout:"BATTLETRANSITIONS.EASINGS.BACKOUT",backinout:"BATTLETRANSITIONS.EASINGS.BACKINOUT",bouncein:"BATTLETRANSITIONS.EASINGS.BOUNCEIN",bounceout:"BATTLETRANSITIONS.EASINGS.BOUNCEOUT",bounceinout:"BATTLETRANSITIONS.EASINGS.BOUNCEINOUT",circin:"BATTLETRANSITIONS.EASINGS.CIRCIN",circout:"BATTLETRANSITIONS.EASINGS.CIRCOUT",circinout:"BATTLETRANSITIONS.EASINGS.CIRCINOUT",elasticin:"BATTLETRANSITIONS.EASINGS.ELASTICIN",elasticout:"BATTLETRANSITIONS.EASINGS.ELASTICOUT",elasticinout:"BATTLETRANSITIONS.EASINGS.ELASTICINOUT",expoin:"BATTLETRANSITIONS.EASINGS.EXPOIN",expoout:"BATTLETRANSITIONS.EASINGS.EXPOOUT",expoinout:"BATTLETRANSITIONS.EASINGS.EXPOINOUT",sinein:"BATTLETRANSITIONS.EASINGS.SINEIN",sineout:"BATTLETRANSITIONS.EASINGS.SINEOUT",sineinout:"BATTLETRANSITIONS.EASINGS.SINEINOUT"}}function p(i,...e){let t=i.serializeArray(),r=e.reduce((n,o)=>({...n,[o]:t.reduce((a,c)=>c.name===o?o==="id"&&!c.value?foundry.utils.randomID():c.value:a,"")}),{});return console.log("Parsed:",r),r}var C=document.createElement("div");C.style.display="none";C.style.position="absolute";C.style.width="100%";C.style.height="100%";C.style.backgroundRepeat="no-repeat";C.id=ke;document.body.appendChild(C);var fe=null;function ut(){fe=new Y,canvas?.stage?.addChild(fe)}async function kt(){if(!canvas)throw new Z;if(!(canvas.app&&canvas.hidden&&canvas.primary&&canvas.tiles&&canvas.drawings&&canvas.scene&&canvas.stage))throw new ce;let i=window.innerWidth,e=window.innerHeight,t=canvas.app.renderer,r=PIXI.RenderTexture.create({width:i,height:e});t.render(canvas.stage,{renderTexture:r,skipUpdateTransform:!0,clear:!0});let n=document.getElementById(ke);if(!n)throw new se;n.style.backgroundImage="";let o=Date.now(),a=await t.extract.image(r),c=document.createElement("canvas"),m=c.getContext("2d");if(!m)throw new y;c.width=a.width,c.height=a.height,m.fillStyle=t.background.backgroundColor.toHex(),m.fillRect(0,0,c.width,c.height),m.drawImage(a,0,0);let E=c.toDataURL();return A(`Image transfered in ${Date.now()-o}ms`),n.style.backgroundImage=`url(${E})`,n.style.backgroundColor=t.background.backgroundColor.toHex(),n.style.display="block",PIXI.Sprite.from(r)}async function rt(){if(!fe)throw new y;let i=await kt(),e=new PIXI.Container,t=l(canvas?.app?.renderer.background.backgroundColor??"white"),r=new PIXI.Sprite(t);return r.width=window.innerWidth,r.height=window.innerHeight,e.addChild(r),e.addChild(i),fe.addChild(e),e}function Me(i){if(C.style.display="none",C.style.backgroundImage="",i){if(Array.isArray(i.children)&&i.children.length)for(let e=i.children.length-1;e>=0;e--)i.children[e].destroy();i.destroy()}}function it(){let i=document.getElementById("loading");i&&(i.style.opacity="0")}function nt(){let i=document.getElementById("loading");i&&i.style.removeProperty("opacity")}function ot(){C.style.display="none",C.style.removeProperty("backgroundImage")}async function at(i){let e=ee(i);if(!(e instanceof Scene))throw new x(typeof i=="string"?i:"[Object object]");return await e.setFlag("battle-transitions","autoTriggered",!0),e.activate(),await de("canvasReady"),e}function lt(){Handlebars.registerHelper("switch",function(i,e){this._switch_value_=i;let t=e.fn(this);return delete this._switch_value_,t}),Handlebars.registerHelper("case",function(i,e){if(i==this._switch_value_)return e.fn(this)})}async function pt(){return loadTemplates(["/modules/battle-transitions/templates/scene-config.hbs",...["add-step","fade-config","linearwipe-config","step-item"].map(i=>`/modules/battle-transitions/templates/config/${i}.hbs`)])}var Te=class{get key(){return"fade"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.FADE"}defaultSettings={duration:1e3,background:"#00000000"};generateSummary(e){return e?[s("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:e.duration}),e.background].join("; "):""}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/fade-config.hbs",{...this.defaultSettings,...e,easingSelect:f()})}createFlagFromHTML(e){return{...this.defaultSettings,...p($(e).find("form"),"id","duration","background","easing")}}};var ge=class{defaultSettings={duration:1e3,background:"#00000000",direction:"left"};generateSummary(e){let t={...this.defaultSettings,...e};return[t.direction,t.duration,t.background].join("; ")}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/linearwipe-config.hbs",{...this.defaultSettings,...e,directionSelect:{top:"BATTLETRANSITIONS.DIRECTIONS.TOP",left:"BATTLETRANSITIONS.DIRECTIONS.LEFT",right:"BATTLETRANSITIONS.DIRECTIONS.RIGHT",bottom:"BATTLETRANSITIONS.DIRECTIONS.BOTTOM",topleft:"BATTLETRANSITIONS.DIRECTIONS.TOPLEFT",topright:"BATTLETRANSITIONS.DIRECTIONS.TOPRIGHT",bottomleft:"BATTLETRANSITIONS.DIRECTIONS.BOTTOMLEFT",bottomright:"BATTLETRANSITIONS.DIRECTIONS.BOTTOMRIGHT"},easingSelect:f()})}createFlagFromHTML(e){return{...this.defaultSettings,...p($(e).find("form"),"id","duration","direction","background","easing")}}get key(){return"linearwipe"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.LINEARWIPE"}};var Ie=class{get key(){return"bilinearwipe"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.BILINEARWIPE"}defaultSettings={duration:1e3,direction:"horizontal",radial:"inside",background:"#00000000"};generateSummary(e){return e?[s("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:e.duration}),e.direction,e.radial,e.background].join("; "):""}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/bilinear-wipe-config.hbs",{...this.defaultSettings,...e,directionSelect:{horizontal:"BATTLETRANSITIONS.DIRECTIONS.HORIZONTAL",vertical:"BATTLETRANSITIONS.DIRECTIONS.VERTICAL",topleft:"BATTLETRANSITIONS.DIRECTIONS.TOPLEFT",topright:"BATTLETRANSITIONS.DIRECTIONS.TOPRIGHT"},radialSelect:{inside:"BATTLETRANSITIONS.DIRECTIONS.INSIDE",outside:"BATTLETRANSITIONS.DIRECTIONS.OUTSIDE"},easingSelect:f()})}createFlagFromHTML(e){return{...this.defaultSettings,...p($(e).find("form"),"duration","background","direction","radial","easing","id")}}};var Se=class{get key(){return"chromakey"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.CHROMAKEY"}defaultSettings={keyColor:"#00b140",background:"#00000000"};generateSummary(e){let t={...this.defaultSettings,...e};return[t.keyColor,t.background].join("; ")}async renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/chromakey-config.hbs",{...this.defaultSettings,...e})}createFlagFromHTML(e){let t=$(e).find("form").serializeArray(),r=t.find(o=>o.name==="key-color"),n=t.find(o=>o.name==="background");return{...this.defaultSettings,...r?{keyColor:r.value}:{},...n?{background:n.value}:{}}}};var he=class{get key(){return"clockwipe"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.CLOCKWIPE"}defaultSettings={direction:"top",clockdirection:"clockwise",duration:1e3,background:"#00000000"};generateSummary(e){let t={...this.defaultSettings,...e};return[t.clockdirection,t.direction,s("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:t.duration}),t.background].join("; ")}async renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/clockwipe-config.hbs",{...this.defaultSettings,...e,directionSelect:{top:"BATTLETRANSITIONS.DIRECTIONS.TOP",left:"BATTLETRANSITIONS.DIRECTIONS.LEFT",right:"BATTLETRANSITIONS.DIRECTIONS.RIGHT",bottom:"BATTLETRANSITIONS.DIRECTIONS.BOTTOM"},clockDirectionSelect:{clockwise:"BATTLETRANSITIONS.DIRECTIONS.CLOCKWISE",counterclockwise:"BATTLETRANSITIONS.DIRECTIONS.COUNTERCLOCKWISE"},easingSelect:f()})}createFlagFromHTML(e){return{...this.defaultSettings,...p($(e).find("form"),"id","duration","direction","background","clockdirection","easing")}}};var be=class{get key(){return"diamondwipe"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.DIAMOND"}defaultSettings={duration:1e3,size:40,background:"#00000000"};generateSummary(e){let t={...this.defaultSettings,...e};return[s("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:t.duration}),s("BATTLETRANSITIONS.FORMATTERS.PIXELS",{value:t.size}),t.background].join("; ")}async renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/diamond-config.hbs",{...this.defaultSettings,...e,easingSelect:f()})}createFlagFromHTML(e){return{...this.defaultSettings,...p($(e).find("form"),"id","duration","size","easing")}}};var Ee=class{get key(){return"firedissolve"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.FIREDISSOLVE"}defaultSettings={duration:1e3,background:"#00000000",burnSize:1.3};generateSummary(e){let t={...this.defaultSettings,...e};return[s("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:t.duration}),t.background].join("; ")}async renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/fire-dissolve-config.hbs",{...this.defaultSettings,...e,easingSelect:f()})}createFlagFromHTML(e){return{...this.defaultSettings,...p($(e).find("form"),"id","duration","background","burnsize","easing")}}};var xe=class{get key(){return"radialwipe"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.RADIALWIPE"}defaultSettings={duration:1e3,background:"#00000000",radial:"inside"};generateSummary(e){let t={...this.defaultSettings,...e};return[s("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:t.duration}),t.radial,t.background].join("; ")}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/radial-wipe-config.hbs",{...e,radialOptions:{inside:"BATTLETRANSITIONS.DIRECTIONS.INSIDE",outside:"BATTLETRANSITIONS.DIRECTIONS.OUTSIDE"},easingSelect:f()})}createFlagFromHTML(e){return{...this.defaultSettings,...p($(e).find("form"),"id","duration","radial","background","easing")}}};var Ce=class{get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.SPOTLIGHTWIPE"}get key(){return"spotlightwipe"}defaultSettings={duration:1e3,background:"#00000000",direction:"top",radial:"outside"};generateSummary(e){let t={...this.defaultSettings,...e};return[s("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:t.duration}),t.direction,t.radial,t.background].join("; ")}createFlagFromHTML(e){return{...this.defaultSettings,...p($(e).find("form"),"id","duration","direction","radial","background","easing")}}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/spotlight-wipe-config.hbs",{...e,directionSelect:{top:"BATTLETRANSITIONS.DIRECTIONS.TOP",left:"BATTLETRANSITIONS.DIRECTIONS.LEFT",right:"BATTLETRANSITIONS.DIRECTIONS.RIGHT",bottom:"BATTLETRANSITIONS.DIRECTIONS.BOTTOM"},radialSelect:{inside:"BATTLETRANSITIONS.DIRECTIONS.INSIDE",outside:"BATTLETRANSITIONS.DIRECTIONS.OUTSIDE"},easingSelect:f()})}};var we=class{get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.TEXTURESWAP"}get key(){return"textureswap"}defaultSettings={texture:""};generateSummary(e){return[{...this.defaultSettings,...e}.texture.split("/").slice(-1)].join("; ")}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/texture-swap-config.hbs",{...this.defaultSettings,...e})}createFlagFromHTML(e){let r=$(e).find("form").serializeArray().find(o=>o.name==="id"),n=$(e).find("form #texture").val()??"";return{...this.defaultSettings,texture:n,id:r?r.value:foundry.utils.randomID()}}};var Ne=class{get key(){return"wait"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.WAIT"}defaultSettings={duration:1e3};generateSummary(e){let t={...this.defaultSettings,...e};return s("BATTLETRANSITIONS.FORMATTERS.MILLISECONDS",{value:t.duration})}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/wait-config.hbs",{...this.defaultSettings,...e})}createFlagFromHTML(e){return{...this.defaultSettings,...p($(e).find("form"),"id","duration")}}};var ye=class{get key(){return"sound"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.SOUND"}defaultSettings={file:"",volume:100};generateSummary(e){let t={...this.defaultSettings,...e};return[t.file.split("/").slice(-1),s("BATTLETRANSITIONS.FORMATTERS.PERCENT",{value:t.volume*100})].join("; ")}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/sound-config.hbs",{...this.defaultSettings,...e})}createFlagFromHTML(e){let t=$(e).find("form").serializeArray(),r=$(e).find("form #file").val()??"",n=t.find(a=>a.name==="volume"),o=t.find(a=>a.name==="id");return{...this.defaultSettings,...r?{file:r}:{},...n?{volume:parseFloat(n.value)}:{},id:o?o.value:foundry.utils.randomID()}}};var Ae=class{get key(){return"video"}get name(){return"BATTLETRANSITIONS.TRANSITIONTYPES.VIDEO"}defaultSettings={file:"",background:"#00000000",volume:1};generateSummary(e){let t={...this.defaultSettings,...e};return[t.file.split("/").splice(-1),s("BATTLETRANSITIONS.FORMATTERS.PERCENT",{value:t.volume*100})].join("; ")}renderTemplate(e){return renderTemplate("/modules/battle-transitions/templates/config/video-config.hbs",{...this.defaultSettings,...e,volume:(e?.volume!==void 0?e.volume:this.defaultSettings.volume)*100})}createFlagFromHTML(e){let t=$(e).find("form #file").val()??"",r=$(e).find("form #volume input[type='number']").val();return{...this.defaultSettings,...t?{file:t}:{},...r?{volume:r/100}:{},...p($(e).find("form"),"id","background")}}};new Se;var G=[new Te,new ge,new Ie,new he,new be,new Ee,new xe,new Ce,new we,new Ne,new ye,new Ae].sort((i,e)=>s(i.name).localeCompare(s(e.name))),Oe=class{#r;#e;#i=null;stepKey="steps";configKey="config";tabName="battle-transitions";icon=["fas","crossed-swords","fa-fw","bt-icon"];get appId(){return this.#r.appId}get rootElement(){return $(this.#r.element)}get addStepDialogElement(){return this.#i?$(this.#i.element):null}updateConfiguration(){let e=[];this.rootElement.find(".step-config-item[data-transition-type]").each((n,o)=>{let a=$(o).data("flag"),c=$(o).data("transition-type");if(!c||typeof c!="string"||typeof a!="object")throw new b("");e.push({...a,type:c})});let r={autoTrigger:this.rootElement.find('[data-tab="battle-transitions"]').find("input#auto-trigger").is(":checked")};Promise.all([this.#e.setFlag("battle-transitions",this.stepKey,e),this.#e.setFlag("battle-transitions",this.configKey,r)])}addEventListeners(){this.rootElement.find("button[data-action='add-step']").on("click",e=>{if($(e.currentTarget).is(":visible"))return this.onAddStep(e)}),this.rootElement.find("#transition-step-list").sortable({handle:".drag-handle",containment:"parent",axis:"y"}),this.rootElement.find("button[type='submit']").on("click",()=>{this.updateConfiguration()}),ColorPicker.install()}onAddStep(e){e.preventDefault(),me()&&foundry.applications.api.DialogV2?this.addStepDialogV2():this.addStepDialog()}resizeDialog(){this.rootElement.find(".item.active[data-tab]").data("tab")===this.tabName&&(this.#r.activateTab("basic"),this.#r.activateTab(this.tabName))}addStepEventListeners(e,t={}){e.find("[data-action='remove']").on("click",()=>{let r=e.data("transition-type")??"",n=G.find(o=>o.key===r);if(!n)throw new b(r);me()&&foundry.applications.api.DialogV2?foundry.applications.api.DialogV2.confirm({content:s("BATTLETRANSITIONS.SCENECONFIG.REMOVECONFIRM",{name:s(n.name)})}).then(o=>{o&&(e.remove(),this.resizeDialog())}):Dialog.confirm({content:s("BATTLETRANSITIONS.SCENECONFIG.REMOVECONFIRM",{name:s(n.name)})}).then(o=>{o&&(e.remove(),this.resizeDialog())})}),e.find("[data-action='configure']").on("click",()=>{let r=e.data("transition-type")??"",n=G.find(a=>a.key===r);if(!n)throw new b(r);let o=e.data("flag")??n.defaultSettings;this.configureStep(r,o)})}addConfigureStepEventListeners(e,t={}){e.find("input[type='text'],input[type='number']").on("focus",r=>{r.currentTarget.select()}),ColorPicker.install()}async configureStep(e,t={}){let r=G.find(o=>o.key===e);if(!r)throw new b(e);let n=await r.renderTemplate(t);me()&&foundry.applications.api.DialogV2?foundry.applications.api.DialogV2.wait({window:{title:s("BATTLETRANSITIONS.SCENECONFIG.EDITSTEPDIALOG.TITLE",{name:s(r.name)})},content:n,render:(o,a)=>{this.addConfigureStepEventListeners($(a),t)},buttons:[{label:"<i class='fas fa-times'></i> "+s("BATTLETRANSITIONS.DIALOGS.BUTTONS.CANCEL"),action:"cancel"},{label:"<i class='fas fa-check'></i> "+s("BATTLETRANSITIONS.DIALOGS.BUTTONS.OK"),action:"ok",default:!0,callback:async(o,a,c)=>{let m=r.createFlagFromHTML($(c));this.addUpdateTransitionStep(e,m)}}]}):await Dialog.wait({title:s("BATTLETRANSITIONS.SCENECONFIG.EDITSTEPDIALOG.TITLE",{name:s(r.name)}),content:n,render:o=>{this.addConfigureStepEventListeners(o,t)},default:"ok",buttons:{cancel:{icon:"<i class='fas fa-times'></i>",label:s("BATTLETRANSITIONS.DIALOGS.BUTTONS.CANCEL")},ok:{icon:"<i class='fas fa-check'></i>",label:s("BATTLETRANSITIONS.DIALOGS.BUTTONS.OK"),callback:o=>{let a=r.createFlagFromHTML(o);this.addUpdateTransitionStep(e,a)}}}})}async addUpdateTransitionStep(e,t={}){let r=G.find(c=>c.key===e);if(!r)throw new b(e);t.id||(t.id=foundry.utils.randomID());let n=await renderTemplate("/modules/battle-transitions/templates/config/step-item.hbs",{...t??{},name:s(r?.name),summary:r.generateSummary(t),type:e,flag:JSON.stringify(t)}),o=$(n),a=this.rootElement.find(`[data-id="${t.id}"]`);a.length?a.replaceWith(o):this.rootElement.find("#transition-step-list").append(o),this.addStepEventListeners(o,t),this.resizeDialog(),ColorPicker.install()}async getRenderedDialogTemplate(){return renderTemplate("/modules/battle-transitions/templates/config/add-step.hbs",{transitionTypes:G.map(e=>({key:e.key,name:e.name}))})}onAddStepDialogRender(){if(!this.addStepDialogElement)throw new ae;this.addStepDialogElement.find("#add-step-form button[data-transition]").on("click",e=>{e.preventDefault();let t=e.currentTarget.dataset.transition??"";this.#i?.close();let r=G.find(n=>n.key===t);if(!r)throw new b(t);this.configureStep(t,r.defaultSettings)})}async addStepDialog(){let e=await this.getRenderedDialogTemplate(),t=new Dialog({title:s("BATTLETRANSITIONS.SCENECONFIG.ADDSTEPDIALOG.TITLE"),content:e,render:()=>{this.onAddStepDialogRender()},buttons:{cancel:{label:s("BATTLETRANSITIONS.DIALOGS.BUTTONS.CANCEL"),icon:"<i class='fas fa-times'></i>"}}});this.#i=t,t.render(!0)}async addStepDialogV2(){let e=await this.getRenderedDialogTemplate();foundry.applications.api.DialogV2.wait({window:{title:"BATTLETRANSITIONS.SCENECONFIG.ADDSTEPDIALOG.TITLE"},rejectClose:!1,render:t=>{this.#i=t.target,this.onAddStepDialogRender()},content:e,buttons:[{label:"<i class='fas fa-times'></i> "+s("BATTLETRANSITIONS.DIALOGS.BUTTONS.CANCEL"),action:"cancel"}]}).then(t=>t==="cancel"?null:t)}async inject(){return game.release?.isNewer("12")?this.injectV12():this.injectV11()}async injectV11(){let e=this.rootElement.find("nav.sheet-tabs.tabs"),t=document.createElement("a");t.classList.add("item"),t.dataset.tab=this.tabName;let r=document.createElement("i");r.classList.add(...this.icon),t.appendChild(r),t.innerHTML+=" "+s("BATTLETRANSITIONS.SCENECONFIG.TAB"),e.append(t);let n=this.#e.getFlag("battle-transitions",this.configKey),o=await renderTemplate("/modules/battle-transitions/templates/scene-config.hbs",n);this.rootElement.find("button[type='submit']").before(`<div class="tab" data-tab="${this.tabName}">${o}</div>`);let a=this.#e.getFlag("battle-transitions",this.stepKey);if(Array.isArray(a))for(let c of a)await this.addUpdateTransitionStep(c.type,c);this.addEventListeners()}async injectV12(){let e=this.rootElement.find("nav.sheet-tabs.tabs[data-group='main']"),t=document.createElement("a");t.classList.add("item"),t.dataset.tab=this.tabName;let r=document.createElement("i");r.classList.add(...this.icon),t.appendChild(r),t.innerHTML+=" "+s("BATTLETRANSITIONS.SCENECONFIG.TAB"),e.append(t);let n=this.#e.getFlag("battle-transitions",this.configKey),o=await renderTemplate("/modules/battle-transitions/templates/scene-config.hbs",n);this.rootElement.find("footer.sheet-footer").before(`<div class="tab" data-group="main" data-tab="${this.tabName}">${o}</div>`);let a=this.#e.getFlag("battle-transitions",this.stepKey);if(Array.isArray(a))for(let c of a)await this.addUpdateTransitionStep(c.type,c);this.addEventListeners()}constructor(e,t){this.#r=e,this.#e=t,this.inject()}};window.BattleTransition=z;Hooks.once("canvasReady",()=>{ut(),Hooks.callAll(Ue.INITIALIZE)});Hooks.on("renderSceneConfig",i=>{new Oe(i,i.object)});Hooks.once("init",async()=>{lt(),await pt()});Hooks.once("socketlib.ready",()=>{L.register(socketlib.registerModule("battle-transitions"))});Hooks.on("getSceneNavigationContext",(i,e)=>{ct(e)});Hooks.on("preUpdateScene",(i,e,t,r)=>{if(e.active&&!(i.getFlag("battle-transitions","autoTriggered")??!1)){let n=i.getFlag("battle-transitions","config"),o=i.getFlag("battle-transitions","steps");n?.autoTrigger&&o?.length&&(e.active=!1,L.transition(i.id,o))}});Hooks.on("updateScene",async(i,e,t,r)=>{e.active&&(i.getFlag("battle-transitions","autoTriggered")??!1)&&i.canUserModify(game.users?.current,"update")&&await i.setFlag("battle-transitions","autoTriggered",!1)});})();
